var S=document.getElementById("status-indicator"),b=S.querySelector(".status-dot"),h=S.querySelector(".status-text"),g=document.getElementById("current-info"),p=document.getElementById("duration"),T=document.getElementById("event-count"),i=document.getElementById("btn-record"),a=document.getElementById("btn-stop"),f=document.getElementById("warning-banner"),c=document.getElementById("sessions-list"),w=document.getElementById("link-options"),I="idle",l=null,d=null;async function r(t){return new Promise((e,n)=>{chrome.runtime.sendMessage(t,o=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):o.success?e(o.data):n(new Error(o.error))})})}function u(t,e){I=t,l=e||null,b.className="status-dot "+t,h.textContent=t==="recording"?"Recording":t==="paused"?"Paused":"Idle",i.hidden=t==="recording",a.hidden=t!=="recording",t==="recording"&&l?(g.hidden=!1,E(),L()):(g.hidden=!0,y())}function E(){if(!l)return;let t=Date.now()-l.startedAt,e=Math.floor(t/1e3),n=Math.floor(e/60),o=Math.floor(n/60);o>0?p.textContent=`${o}:${(n%60).toString().padStart(2,"0")}:${(e%60).toString().padStart(2,"0")}`:p.textContent=`${n.toString().padStart(2,"0")}:${(e%60).toString().padStart(2,"0")}`}function L(){y(),d=setInterval(E,1e3)}function y(){d&&(clearInterval(d),d=null)}function v(t){T.textContent=t.toString()}async function R(){try{i.disabled=!0,i.textContent="Starting...";let[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t?.url)throw new Error("No active tab");await r({type:"CHECK_SENSITIVE_DOMAIN",url:t.url})&&(f.hidden=!1);let n=await r({type:"START_RECORDING"});u("recording",n)}catch(t){console.error("Failed to start recording:",t),alert("Failed to start recording: "+t.message)}finally{i.disabled=!1,i.innerHTML='<span class="btn-icon">\u25CF</span> Start Recording'}}async function M(){try{a.disabled=!0,a.textContent="Stopping...",await r({type:"STOP_RECORDING"}),u("idle",null),f.hidden=!0,await m()}catch(t){console.error("Failed to stop recording:",t),alert("Failed to stop recording: "+t.message)}finally{a.disabled=!1,a.innerHTML='<span class="btn-icon">\u25A0</span> Stop Recording'}}async function m(){try{let t=await r({type:"GET_SESSIONS"});if(!t||t.length===0){c.innerHTML='<p class="empty-state">No sessions recorded yet.</p>';return}let e=t.slice(0,5);c.innerHTML=e.map(n=>C(n)).join(""),c.querySelectorAll(".session-item").forEach(n=>{let o=n.getAttribute("data-session-id");n.querySelector(".btn-export")?.addEventListener("click",s=>{s.stopPropagation(),D(o)}),n.querySelector(".btn-delete")?.addEventListener("click",s=>{s.stopPropagation(),$(o)})})}catch(t){console.error("Failed to load sessions:",t),c.innerHTML='<p class="empty-state error">Failed to load sessions.</p>'}}function C(t){let e=new Date(t.startedAt).toLocaleDateString(),n=new Date(t.startedAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),o=t.endedAt?P(t.endedAt-t.startedAt):"In progress";return`
    <div class="session-item" data-session-id="${t.id}">
      <div class="session-info">
        <div class="session-title">${B(O(t.title,30))}</div>
        <div class="session-meta">
          <span>${e} ${n}</span>
          <span>\u2022</span>
          <span>${o}</span>
          <span>\u2022</span>
          <span>${t.eventCount} events</span>
        </div>
      </div>
      <div class="session-actions">
        <button class="btn-icon-only btn-export" title="Export">\u2B07</button>
        <button class="btn-icon-only btn-delete" title="Delete">\xD7</button>
      </div>
    </div>
  `}async function D(t){try{let e=await r({type:"EXPORT_SESSION",sessionId:t}),n=new Blob([e],{type:"text/markdown"}),o=URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=`dom-chronicle-${t.substring(0,8)}.md`,s.click(),URL.revokeObjectURL(o)}catch(e){console.error("Failed to export session:",e),alert("Failed to export session: "+e.message)}}async function $(t){if(confirm("Delete this recording? This cannot be undone."))try{await r({type:"DELETE_SESSION",sessionId:t}),await m()}catch(e){console.error("Failed to delete session:",e),alert("Failed to delete session: "+e.message)}}async function x(){try{let t=await r({type:"GET_STATUS"});u(t.state,t.session),t.eventCount!==void 0&&v(t.eventCount)}catch(t){console.error("Failed to get status:",t)}}function P(t){let e=Math.floor(t/1e3),n=Math.floor(e/60);return n<1?`${e}s`:n<60?`${n}m ${e%60}s`:`${Math.floor(n/60)}h ${n%60}m`}function O(t,e){return t.length>e?t.substring(0,e-1)+"\u2026":t}function B(t){let e=document.createElement("div");return e.textContent=t,e.innerHTML}i.addEventListener("click",R);a.addEventListener("click",M);w.addEventListener("click",t=>{t.preventDefault(),chrome.runtime.openOptionsPage()});chrome.runtime.onMessage.addListener(t=>{t.type==="EVENT_COUNT_UPDATE"&&v(t.count)});document.addEventListener("DOMContentLoaded",async()=>{await x(),await m()});
