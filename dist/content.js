var c=class{describe(t){return!t||!(t instanceof Element)?this.describeNonElement(t):{tagName:t.tagName.toLowerCase(),id:t.id||void 0,classes:Array.from(t.classList),role:this.getRole(t),label:this.getLabel(t),xpath:this.getXPath(t),cssSelector:this.getCssSelector(t),boundingRect:this.getBoundingRect(t)}}describeNonElement(t){return{tagName:t?.nodeName.toLowerCase()||"unknown",classes:[],xpath:"",cssSelector:""}}getRole(t){let e=t.getAttribute("role");if(e)return e;let n={button:"button",a:"link",input:s=>this.getInputRole(s),select:"combobox",textarea:"textbox",img:"img",nav:"navigation",main:"main",header:"banner",footer:"contentinfo",form:"form",table:"table",ul:"list",ol:"list",li:"listitem",dialog:"dialog",article:"article",section:"region",aside:"complementary"},i=t.tagName.toLowerCase(),r=n[i];return typeof r=="function"?r(t):r}getInputRole(t){return{text:"textbox",password:"textbox",email:"textbox",tel:"textbox",url:"textbox",search:"searchbox",number:"spinbutton",range:"slider",checkbox:"checkbox",radio:"radio",button:"button",submit:"button",reset:"button",image:"button"}[t.type]||"textbox"}getLabel(t){let e=[()=>t.getAttribute("aria-label"),()=>{let n=t.getAttribute("aria-labelledby");return n?document.getElementById(n)?.textContent:null},()=>t.getAttribute("title"),()=>t.getAttribute("alt"),()=>t.getAttribute("placeholder"),()=>this.findAssociatedLabel(t),()=>{let n=t.textContent?.trim();return n&&n.length<=50?n:n?.substring(0,47)+"..."}];for(let n of e){let i=n();if(i?.trim())return i.trim()}}findAssociatedLabel(t){if(t.id){let n=document.querySelector(`label[for="${t.id}"]`);if(n)return n.textContent?.trim()||null}let e=t.closest("label");if(e){let n=e.cloneNode(!0);return n.querySelectorAll("input, select, textarea").forEach(r=>r.remove()),n.textContent?.trim()||null}return null}getCssSelector(t){if(t.id)return`#${CSS.escape(t.id)}`;let e=[],n=t;for(;n&&n!==document.body&&n!==document.documentElement;){let i=n.tagName.toLowerCase();if(n.id){i=`#${CSS.escape(n.id)}`,e.unshift(i);break}if(n.className&&typeof n.className=="string"){let s=n.className.trim().split(/\s+/).slice(0,2);s.length&&(i+="."+s.map(l=>CSS.escape(l)).join("."))}let r=n.parentElement;if(r){let l=Array.from(r.children).filter(u=>u.tagName===n.tagName);if(l.length>1){let u=l.indexOf(n)+1;i+=`:nth-of-type(${u})`}}e.unshift(i),n=n.parentElement}return e.join(" > ")}getXPath(t){if(t.id)return`//*[@id="${t.id}"]`;let e=[],n=t;for(;n&&n.nodeType===Node.ELEMENT_NODE;){let i=1,r=n.previousElementSibling;for(;r;)r.tagName===n.tagName&&i++,r=r.previousElementSibling;let s=n.tagName.toLowerCase();e.unshift(`${s}[${i}]`),n=n.parentElement}return"/"+e.join("/")}getBoundingRect(t){try{let e=t.getBoundingClientRect();return{x:Math.round(e.x),y:Math.round(e.y),width:Math.round(e.width),height:Math.round(e.height)}}catch{return}}captureFragment(t,e=2e3){if(!t)return;let n="",i="",r={};if(t instanceof Element){n=t.outerHTML.substring(0,e),i=t.textContent?.trim().substring(0,500)||"";for(let s of t.attributes)r[s.name]=s.value}else t.nodeType===Node.TEXT_NODE&&(i=t.textContent?.trim()||"",n=i);return{html:n,text:i,attributes:r}}};var a={MAX_EVENTS_IN_MEMORY:500,MAX_DOM_FRAGMENT_SIZE:2e3,MAX_EVENTS_PER_SESSION:5e4,BUFFER_FLUSH_INTERVAL:500,SESSION_AUTO_STOP_HOURS:2,INPUT_DEBOUNCE_MS:100,SCROLL_THROTTLE_MS:200},y={maxInitialHTMLSize:100*1024,diffMode:"line",includeParentContext:!0};var d=class{observer=null;extractor;callback;sessionId="";sequence=0;batchBuffer=[];batchTimeout=null;includeParentContext=!0;constructor(t){this.callback=t,this.extractor=new c}start(t,e=!0){this.sessionId=t,this.sequence=0,this.includeParentContext=e,this.observer=new MutationObserver(n=>{this.batchMutations(n)}),this.observer.observe(document.body,{childList:!0,attributes:!0,characterData:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0})}stop(){this.batchTimeout&&(clearTimeout(this.batchTimeout),this.processBatch()),this.observer?.disconnect(),this.observer=null}batchMutations(t){let e=t.map(n=>{let i={record:n};if(this.includeParentContext&&n.type==="childList"){let r=n.target instanceof Element?n.target:n.target.parentElement;r&&(i.parentHTMLBefore=this.reconstructBeforeState(r,n))}return i});this.batchBuffer.push(...e),this.batchTimeout===null&&(this.batchTimeout=setTimeout(()=>{this.processBatch(),this.batchTimeout=null},50))}reconstructBeforeState(t,e){let n=t.cloneNode(!0);return e.addedNodes.forEach(i=>{let r=Array.from(n.childNodes).find(s=>s.isEqualNode(i));r&&n.removeChild(r)}),e.removedNodes.forEach(i=>{n.appendChild(i.cloneNode(!0))}),n.outerHTML}processBatch(){let t=this.batchBuffer.splice(0);for(let e of t)this.processMutation(e)}processMutation(t){let e=this.createEvent(t);e&&this.callback(e)}createEvent(t){let e=t.record,n=this.getMutationType(e);if(!n)return null;let i=e.target instanceof Element?e.target:e.target.parentElement;if(!i||this.shouldIgnore(i))return null;let r=this.buildPayload(t);return{id:crypto.randomUUID(),sessionId:this.sessionId,timestamp:performance.now(),sequence:this.sequence++,type:n,target:this.extractor.describe(i),payload:r,domSnapshot:this.captureContext(e)}}getMutationType(t){switch(t.type){case"childList":return t.addedNodes.length>0?"mutation:add":t.removedNodes.length>0?"mutation:remove":null;case"attributes":return"mutation:attribute";case"characterData":return"mutation:text";default:return null}}buildPayload(t){let e=t.record,n={kind:"mutation",mutationType:e.type};if(e.type==="childList"){if(e.addedNodes.length>0&&(n.addedNodes=Array.from(e.addedNodes).filter(i=>i instanceof Element).slice(0,10).map(i=>this.extractor.captureFragment(i,a.MAX_DOM_FRAGMENT_SIZE)).filter(i=>i!==void 0)),e.removedNodes.length>0&&(n.removedNodes=Array.from(e.removedNodes).filter(i=>i instanceof Element).slice(0,10).map(i=>this.extractor.captureFragment(i,a.MAX_DOM_FRAGMENT_SIZE)).filter(i=>i!==void 0)),this.includeParentContext){let i=e.target instanceof Element?e.target:e.target.parentElement;n.parentHTMLBefore=t.parentHTMLBefore,n.parentHTMLAfter=i?.outerHTML}}else e.type==="attributes"?(n.attributeName=e.attributeName||void 0,n.oldValue=e.oldValue||void 0,n.newValue=e.target instanceof Element&&e.target.getAttribute(e.attributeName||"")||void 0):e.type==="characterData"&&(n.oldValue=e.oldValue||void 0,n.newValue=e.target.textContent||void 0);return n}captureContext(t){let e=t.target instanceof Element?t.target:t.target.parentElement;return e?this.extractor.captureFragment(e,a.MAX_DOM_FRAGMENT_SIZE):void 0}shouldIgnore(t){return["script","style","noscript","link","meta"].includes(t.tagName.toLowerCase())}};function f(o,t){let e=null;return function(...i){e!==null&&clearTimeout(e),e=setTimeout(()=>{o(...i),e=null},t)}}function g(o,t){let e=0,n=null;return function(...r){let s=Date.now(),l=t-(s-e);l<=0?(n!==null&&(clearTimeout(n),n=null),e=s,o(...r)):n===null&&(n=setTimeout(()=>{e=Date.now(),n=null,o(...r)},l))}}var p=class{extractor;callback;sessionId="";sequence=0;config;listeners=[];constructor(t,e){this.callback=t,this.extractor=new c,this.config={captureScrollEvents:!1,captureMouseMovement:!1,debounceMs:a.INPUT_DEBOUNCE_MS,...e}}start(t,e=0){this.sessionId=t,this.sequence=e,this.addListener(document,"click",this.handleClick.bind(this),!0);let n=f(this.handleInput.bind(this),this.config.debounceMs);if(this.addListener(document,"input",n,!0),this.addListener(document,"focus",this.handleFocus.bind(this),!0),this.addListener(document,"blur",this.handleBlur.bind(this),!0),this.config.captureScrollEvents){let i=g(this.handleScroll.bind(this),a.SCROLL_THROTTLE_MS);this.addListener(document,"scroll",i,!0)}this.addListener(window,"popstate",this.handleNavigation.bind(this)),this.addListener(window,"hashchange",this.handleNavigation.bind(this)),this.interceptHistoryAPI()}stop(){for(let{target:t,type:e,handler:n}of this.listeners)t.removeEventListener(e,n,!0);this.listeners=[]}addListener(t,e,n,i=!1){t.addEventListener(e,n,i),this.listeners.push({target:t,type:e,handler:n})}handleClick(t){let e=t,n=t.target;if(!n)return;let i={kind:"click",button:e.button,coordinates:{x:e.clientX,y:e.clientY},modifiers:{ctrl:e.ctrlKey,shift:e.shiftKey,alt:e.altKey,meta:e.metaKey}};this.emit("user:click",n,i)}handleInput(t){let e=t.target;if(!e)return;let n={kind:"input",inputType:e.type||"text",value:e.value||"",selectionStart:"selectionStart"in e?e.selectionStart??void 0:void 0,selectionEnd:"selectionEnd"in e?e.selectionEnd??void 0:void 0};this.emit("user:input",e,n)}handleFocus(t){let e=t.target;if(!e)return;let n={kind:"focus",focused:!0};this.emit("user:focus",e,n)}handleBlur(t){let e=t.target;if(!e)return;let n={kind:"focus",focused:!1};this.emit("user:blur",e,n)}handleScroll(t){let e={kind:"scroll",scrollX:window.scrollX,scrollY:window.scrollY};this.emit("user:scroll",document.documentElement,e)}handleNavigation(t){let e=t.type==="popstate"?"popstate":"hashchange",n={kind:"navigation",url:window.location.href,type:e};this.emit("user:navigation",document.documentElement,n)}interceptHistoryAPI(){let t=history.pushState.bind(history),e=history.replaceState.bind(history);history.pushState=(...n)=>{t(...n),this.emitNavigation("pushState")},history.replaceState=(...n)=>{e(...n),this.emitNavigation("replaceState")}}emitNavigation(t){let e={kind:"navigation",url:window.location.href,type:t};this.emit("user:navigation",document.documentElement,e)}emit(t,e,n){let i={id:crypto.randomUUID(),sessionId:this.sessionId,timestamp:performance.now(),sequence:this.sequence++,type:t,target:this.extractor.describe(e),payload:n,domSnapshot:t==="user:click"?this.extractor.captureFragment(e,a.MAX_DOM_FRAGMENT_SIZE):void 0};this.callback(i)}getSequence(){return this.sequence}};var v=[{id:"input-password",name:"Password fields",type:"input-type",pattern:"password",replacement:"[PASSWORD]",enabled:!0},{id:"input-hidden",name:"Hidden inputs",type:"input-type",pattern:"hidden",replacement:"[HIDDEN]",enabled:!0},{id:"regex-email",name:"Email addresses",type:"regex",pattern:"[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}",replacement:"[EMAIL]",enabled:!0},{id:"regex-phone",name:"Phone numbers",type:"regex",pattern:"(\\+?1?[-.\\s]?)?(\\(?\\d{3}\\)?[-.\\s]?)?\\d{3}[-.\\s]?\\d{4}",replacement:"[PHONE]",enabled:!0},{id:"regex-ssn",name:"Social Security Numbers",type:"regex",pattern:"\\b\\d{3}-\\d{2}-\\d{4}\\b",replacement:"[SSN]",enabled:!0},{id:"regex-credit-card",name:"Credit card numbers",type:"regex",pattern:"\\b(?:\\d{4}[- ]?){3}\\d{4}\\b",replacement:"[CARD]",enabled:!0},{id:"regex-ip-address",name:"IP addresses",type:"regex",pattern:"\\b(?:\\d{1,3}\\.){3}\\d{1,3}\\b",replacement:"[IP]",enabled:!1},{id:"selector-cvv",name:"CVV fields",type:"selector",pattern:'input[name*="cvv"], input[name*="cvc"], input[autocomplete="cc-csc"]',replacement:"[CVV]",enabled:!0},{id:"attr-auth-token",name:"Auth tokens",type:"attribute",pattern:"data-token,data-auth,data-session,data-csrf",replacement:"[TOKEN]",enabled:!0}];var h=class{rules=[];compiledRegex=new Map;loadRules(t){this.rules=[...v,...t||[]],this.compiledRegex.clear();for(let e of this.rules)if(e.type==="regex"&&e.enabled)try{this.compiledRegex.set(e.id,new RegExp(e.pattern,"gi"))}catch(n){console.warn(`Invalid regex pattern in rule ${e.id}:`,n)}}process(t){let e={...t};if(e.target.label&&(e.target={...e.target,label:this.redactText(e.target.label)}),t.type==="user:input"&&t.payload){let n=t.payload;this.shouldRedactInputType(t.target,n.inputType)?e.payload={...n,value:this.getReplacementForInputType(t.target,n.inputType)}:e.payload={...n,value:this.redactText(n.value)}}return e.domSnapshot&&(e.domSnapshot={...e.domSnapshot,html:this.redactText(e.domSnapshot.html),text:this.redactText(e.domSnapshot.text),attributes:this.redactAttributes(e.domSnapshot.attributes)}),e}redactText(t){let e=t;for(let n of this.rules){if(!n.enabled||n.type!=="regex")continue;let i=this.compiledRegex.get(n.id);i&&(e=e.replace(i,n.replacement),i.lastIndex=0)}return e}shouldRedactInputType(t,e){for(let n of this.rules)if(n.enabled){if(n.type==="input-type"&&n.pattern===e)return!0;if(n.type==="selector"&&t.cssSelector)try{let i=n.pattern.split(",").map(r=>r.trim());for(let r of i)if(this.matchesSelectorPattern(t,r))return!0}catch{}}return!1}getReplacementForInputType(t,e){for(let n of this.rules)if(n.enabled){if(n.type==="input-type"&&n.pattern===e)return n.replacement;if(n.type==="selector"){let i=n.pattern.split(",").map(r=>r.trim());for(let r of i)if(this.matchesSelectorPattern(t,r))return n.replacement}}return"[REDACTED]"}matchesSelectorPattern(t,e){if(e.startsWith(t.tagName)){let n=e.match(/\[(\w+)([*^$]?)="([^"]+)"\]/);if(n){let[,i,r,s]=n;if(i==="id"&&t.id)return this.matchAttributeValue(t.id,r,s);if(i==="autocomplete"&&t.cssSelector.includes(s)||i==="name"&&t.cssSelector.includes(s))return!0}}return!1}matchAttributeValue(t,e,n){switch(e){case"*":return t.includes(n);case"^":return t.startsWith(n);case"$":return t.endsWith(n);default:return t===n}}redactAttributes(t){let e={};for(let[n,i]of Object.entries(t)){let r=!1;for(let s of this.rules){if(!s.enabled||s.type!=="attribute")continue;if(s.pattern.split(",").map(u=>u.trim()).includes(n)){e[n]=s.replacement,r=!0;break}}r||(e[n]=this.redactText(i))}return e}getRules(){return[...this.rules]}toggleRule(t,e){let n=this.rules.find(i=>i.id===t);n&&(n.enabled=e)}addRule(t){if(this.rules.push(t),t.type==="regex"&&t.enabled)try{this.compiledRegex.set(t.id,new RegExp(t.pattern,"gi"))}catch{}}};var m=class{isRecording=!1;sessionId=null;config=null;redactionEngine;mutationCapture;eventCapture=null;eventBuffer=[];flushInterval=null;sequence=0;constructor(){this.redactionEngine=new h,this.mutationCapture=new d(t=>{this.handleEvent(t)}),this.setupMessageListener()}setupMessageListener(){chrome.runtime.onMessage.addListener((t,e,n)=>(this.handleMessage(t,n),!0))}async handleMessage(t,e){try{switch(t.type){case"START_RECORDING":await this.start(t.sessionId,t.config),e({success:!0});break;case"STOP_RECORDING":await this.stop(),e({success:!0});break;case"GET_STATUS":e({success:!0,data:{isRecording:this.isRecording,sessionId:this.sessionId,eventCount:this.sequence}});break;case"UPDATE_CONFIG":this.config&&(this.config={...this.config,...t.config}),e({success:!0});break;default:e({success:!1,error:"Unknown message type"})}}catch(n){e({success:!1,error:n instanceof Error?n.message:"Unknown error"})}}async start(t,e){if(this.isRecording)throw new Error("Already recording");this.sessionId=t,this.config=e,this.sequence=0,this.eventBuffer=[],this.isRecording=!0,this.redactionEngine.loadRules(e.redactionRules);let n=e.exportConfig?.includeParentContext??!0;this.mutationCapture.start(t,n);let i={captureScrollEvents:e.captureScrollEvents,debounceMs:e.debounceMs};this.eventCapture=new p(r=>{this.handleEvent(r)},i),this.eventCapture.start(t,this.sequence),this.startBufferFlush(),this.captureInitialState(),console.log("[DOM Chronicle] Recording started for session:",t)}async stop(){this.isRecording&&(this.isRecording=!1,this.mutationCapture.stop(),this.eventCapture?.stop(),this.eventCapture=null,this.stopBufferFlush(),await this.flushBuffer(),console.log("[DOM Chronicle] Recording stopped. Total events:",this.sequence),this.sessionId=null,this.config=null)}handleEvent(t){if(!this.isRecording||!this.config)return;if(!this.checkRateLimit()){console.warn("[DOM Chronicle] Rate limit exceeded, dropping event");return}let e=this.redactionEngine.process(t);e.sequence=this.sequence++,this.eventBuffer.push(e),this.eventBuffer.length>=a.MAX_EVENTS_IN_MEMORY&&this.flushBuffer()}captureInitialState(){if(!this.sessionId)return;let t=document.documentElement.outerHTML,e=this.config?.exportConfig?.maxInitialHTMLSize??0;e>0&&t.length>e&&(t=t.substring(0,e)+`
<!-- TRUNCATED -->`);let n={id:crypto.randomUUID(),sessionId:this.sessionId,timestamp:performance.now(),sequence:this.sequence++,type:"user:navigation",target:{tagName:"document",classes:[],xpath:"/",cssSelector:":root"},payload:{kind:"navigation",url:window.location.href,type:"pageload",initialHTML:t}};this.eventBuffer.push(n)}startBufferFlush(){this.flushInterval=setInterval(()=>{this.flushBuffer()},a.BUFFER_FLUSH_INTERVAL)}stopBufferFlush(){this.flushInterval&&(clearInterval(this.flushInterval),this.flushInterval=null)}async flushBuffer(){if(this.eventBuffer.length===0)return;let t=this.eventBuffer.splice(0);try{await chrome.runtime.sendMessage({type:"STORE_EVENTS",events:t})}catch(e){console.error("[DOM Chronicle] Failed to flush events:",e),this.eventBuffer.unshift(...t)}}checkRateLimit(){if(!this.config)return!1;let t=a.MAX_EVENTS_PER_SESSION;return this.sequence>=t?(console.warn("[DOM Chronicle] Session event limit reached"),this.stop(),!1):!0}},b=new m;window.__domChronicle=b;console.log("[DOM Chronicle] Content script loaded");
