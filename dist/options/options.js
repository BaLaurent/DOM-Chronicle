var C=[{id:"input-password",name:"Password fields",type:"input-type",pattern:"password",replacement:"[PASSWORD]",enabled:!0},{id:"input-hidden",name:"Hidden inputs",type:"input-type",pattern:"hidden",replacement:"[HIDDEN]",enabled:!0},{id:"regex-email",name:"Email addresses",type:"regex",pattern:"[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}",replacement:"[EMAIL]",enabled:!0},{id:"regex-phone",name:"Phone numbers",type:"regex",pattern:"(\\+?1?[-.\\s]?)?(\\(?\\d{3}\\)?[-.\\s]?)?\\d{3}[-.\\s]?\\d{4}",replacement:"[PHONE]",enabled:!0},{id:"regex-ssn",name:"Social Security Numbers",type:"regex",pattern:"\\b\\d{3}-\\d{2}-\\d{4}\\b",replacement:"[SSN]",enabled:!0},{id:"regex-credit-card",name:"Credit card numbers",type:"regex",pattern:"\\b(?:\\d{4}[- ]?){3}\\d{4}\\b",replacement:"[CARD]",enabled:!0},{id:"regex-ip-address",name:"IP addresses",type:"regex",pattern:"\\b(?:\\d{1,3}\\.){3}\\d{1,3}\\b",replacement:"[IP]",enabled:!1},{id:"selector-cvv",name:"CVV fields",type:"selector",pattern:'input[name*="cvv"], input[name*="cvc"], input[autocomplete="cc-csc"]',replacement:"[CVV]",enabled:!0},{id:"attr-auth-token",name:"Auth tokens",type:"attribute",pattern:"data-token,data-auth,data-session,data-csrf",replacement:"[TOKEN]",enabled:!0}];var P="dom-chronicle";var i={SESSIONS:"sessions",EVENTS:"events",CONFIG:"config"};var Ee={maxInitialHTMLSize:100*1024,diffMode:"line",includeParentContext:!0};var S=null;async function y(){return S||new Promise((e,t)=>{let n=indexedDB.open(P,1);n.onerror=()=>t(n.error),n.onsuccess=()=>{S=n.result,e(S)},n.onupgradeneeded=o=>{let s=o.target.result;if(!s.objectStoreNames.contains(i.SESSIONS)){let r=s.createObjectStore(i.SESSIONS,{keyPath:"id"});r.createIndex("startedAt","startedAt"),r.createIndex("url","url")}if(!s.objectStoreNames.contains(i.EVENTS)){let r=s.createObjectStore(i.EVENTS,{keyPath:"id"});r.createIndex("sessionId","sessionId"),r.createIndex("timestamp","timestamp"),r.createIndex("type","type"),r.createIndex("session-sequence",["sessionId","sequence"])}s.objectStoreNames.contains(i.CONFIG)||s.createObjectStore(i.CONFIG,{keyPath:"key"})}})}async function x(){let s=(await y()).transaction(i.SESSIONS,"readonly").objectStore(i.SESSIONS).index("startedAt").getAll();return new Promise((r,c)=>{s.onsuccess=()=>{let f=s.result;r(f.reverse())},s.onerror=()=>c(s.error)})}async function l(e){let s=(await y()).transaction(i.CONFIG,"readonly").objectStore(i.CONFIG).get(e);return new Promise((r,c)=>{s.onsuccess=()=>r(s.result?.value),s.onerror=()=>c(s.error)})}async function d(e,t){let o=(await y()).transaction(i.CONFIG,"readwrite");return o.objectStore(i.CONFIG).put({key:e,value:t}),new Promise((r,c)=>{o.oncomplete=()=>r(),o.onerror=()=>c(o.error)})}var a={CAPTURE_SCROLL:"captureScrollEvents",DEBOUNCE_MS:"debounceMs",MAX_EVENTS:"maxEventsPerMinute",CUSTOM_RULES:"customRedactionRules",DISABLED_DEFAULTS:"disabledDefaultRules",MAX_INITIAL_HTML:"maxInitialHTMLSize",DIFF_MODE:"diffMode",INCLUDE_PARENT_CONTEXT:"includeParentContext"},L=document.getElementById("capture-scroll"),h=document.getElementById("debounce-ms"),N=document.getElementById("max-events"),w=document.getElementById("max-initial-html"),A=document.getElementById("diff-mode"),R=document.getElementById("include-parent-context"),G=document.getElementById("default-rules"),B=document.getElementById("custom-rules"),z=document.getElementById("btn-add-rule"),p=document.getElementById("btn-export-all"),Z=document.getElementById("btn-clear-all"),F=document.getElementById("save-status"),I=document.getElementById("rule-modal"),k=document.getElementById("rule-form"),K=document.getElementById("rule-name"),M=document.getElementById("rule-type"),Y=document.getElementById("rule-pattern"),V=document.getElementById("rule-replacement"),W=document.getElementById("pattern-help"),J=document.getElementById("btn-cancel-rule"),Q=document.getElementById("total-sessions"),ee=document.getElementById("total-events"),U=document.getElementById("storage-used"),g=document.getElementById("sessions-list"),u=[],E=new Set,T=null;async function te(){try{let e=await l(a.CAPTURE_SCROLL),t=await l(a.DEBOUNCE_MS),n=await l(a.MAX_EVENTS),o=await l(a.CUSTOM_RULES),s=await l(a.DISABLED_DEFAULTS),r=await l(a.MAX_INITIAL_HTML),c=await l(a.DIFF_MODE),f=await l(a.INCLUDE_PARENT_CONTEXT);L.checked=e??!1,h.value=(t??100).toString(),N.value=(n??1e3).toString(),w.value=((r??100*1024)/1024).toString(),A.value=c??"line",R.checked=f??!0,u=o||[],E=new Set(s||[]),v(),await O(),await _()}catch(e){console.error("Failed to load settings:",e)}}function m(){T&&clearTimeout(T),T=setTimeout(async()=>{try{await d(a.CAPTURE_SCROLL,L.checked),await d(a.DEBOUNCE_MS,parseInt(h.value,10)),await d(a.MAX_EVENTS,parseInt(N.value,10)),await d(a.CUSTOM_RULES,u),await d(a.DISABLED_DEFAULTS,Array.from(E)),await d(a.MAX_INITIAL_HTML,parseInt(w.value,10)*1024),await d(a.DIFF_MODE,A.value),await d(a.INCLUDE_PARENT_CONTEXT,R.checked),$()}catch(e){console.error("Failed to save settings:",e)}},500)}function $(){F.hidden=!1,setTimeout(()=>{F.hidden=!0},2e3)}function v(){G.innerHTML=C.map(e=>H(e,!1)).join(""),u.length===0?B.innerHTML='<p class="empty-state">No custom rules defined.</p>':B.innerHTML=u.map(e=>H(e,!0)).join(""),document.querySelectorAll(".rule-toggle").forEach(e=>{e.addEventListener("change",ne)}),document.querySelectorAll(".btn-delete-rule").forEach(e=>{e.addEventListener("click",oe)})}function H(e,t){let n=t?e.enabled:!E.has(e.id);return`
    <div class="rule-item" data-rule-id="${e.id}" data-custom="${t}">
      <div class="rule-info">
        <label class="checkbox-label">
          <input type="checkbox" class="rule-toggle" ${n?"checked":""}>
          <span class="rule-name">${b(e.name)}</span>
        </label>
        <div class="rule-meta">
          <span class="rule-type">${e.type}</span>
          <code class="rule-pattern">${b(q(e.pattern,40))}</code>
          <span class="rule-replacement">\u2192 ${b(e.replacement)}</span>
        </div>
      </div>
      ${t?'<button class="btn-icon-only btn-delete-rule" title="Delete">\xD7</button>':""}
    </div>
  `}function ne(e){let t=e.target,n=t.closest(".rule-item"),o=n.getAttribute("data-rule-id");if(n.getAttribute("data-custom")==="true"){let r=u.find(c=>c.id===o);r&&(r.enabled=t.checked)}else t.checked?E.delete(o):E.add(o);m()}function oe(e){let o=e.target.closest(".rule-item").getAttribute("data-rule-id");confirm("Delete this custom rule?")&&(u=u.filter(s=>s.id!==o),v(),m())}function se(){k.reset(),V.value="[REDACTED]",j(),I.showModal()}function D(){I.close()}function j(){let e={regex:"Regular expression to match (e.g., \\b[A-Z0-9]{32}\\b)",selector:'CSS selector (e.g., input[name*="api"], .secret-field)',"input-type":"Input type attribute (e.g., password, hidden)",attribute:"Comma-separated attribute names (e.g., data-secret,data-key)"};W.textContent=e[M.value]||""}function re(e){e.preventDefault();let t={id:`custom-${Date.now()}`,name:K.value.trim(),type:M.value,pattern:Y.value.trim(),replacement:V.value.trim()||"[REDACTED]",enabled:!0};if(t.type==="regex")try{new RegExp(t.pattern)}catch{alert("Invalid regular expression pattern");return}u.push(t),v(),m(),D()}async function O(){try{let e=await x(),t=e.reduce((n,o)=>n+o.eventCount,0);if(Q.textContent=e.length.toString(),ee.textContent=t.toLocaleString(),"storage"in navigator&&"estimate"in navigator.storage){let o=(((await navigator.storage.estimate()).usage||0)/1024/1024).toFixed(2);U.textContent=`${o} MB`}else U.textContent="N/A"}catch(e){console.error("Failed to load stats:",e)}}async function _(){try{let e=await x();if(!e||e.length===0){g.innerHTML='<p class="empty-state">No sessions recorded yet.</p>';return}g.innerHTML=e.map(t=>ae(t)).join(""),g.querySelectorAll(".session-item").forEach(t=>{let n=t.getAttribute("data-session-id");t.querySelector(".btn-export")?.addEventListener("click",o=>{o.stopPropagation(),ie(n)}),t.querySelector(".btn-delete")?.addEventListener("click",o=>{o.stopPropagation(),ce(n)})})}catch(e){console.error("Failed to load sessions:",e),g.innerHTML='<p class="empty-state">Failed to load sessions.</p>'}}function ae(e){let t=new Date(e.startedAt).toLocaleDateString(),n=new Date(e.startedAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),o=e.endedAt?le(e.endedAt-e.startedAt):"In progress";return`
    <div class="session-item" data-session-id="${e.id}">
      <div class="session-info">
        <div class="session-title">${b(q(e.title,50))}</div>
        <div class="session-meta">
          <span>${t} ${n}</span>
          <span>\u2022</span>
          <span>${o}</span>
          <span>\u2022</span>
          <span>${e.eventCount} events</span>
        </div>
      </div>
      <div class="session-actions">
        <button class="btn-icon-only btn-export" title="Export">\u2B07</button>
        <button class="btn-icon-only btn-delete" title="Delete">\xD7</button>
      </div>
    </div>
  `}async function ie(e){try{let t=await chrome.runtime.sendMessage({type:"EXPORT_SESSION",sessionId:e});if(t.success&&t.data){let n=new Blob([t.data],{type:"text/markdown"}),o=URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=`dom-chronicle-${e.substring(0,8)}.md`,s.click(),URL.revokeObjectURL(o)}else throw new Error(t.error||"Export failed")}catch(t){console.error("Failed to export session:",t),alert("Failed to export session")}}async function ce(e){if(confirm("Delete this recording? This cannot be undone."))try{await chrome.runtime.sendMessage({type:"DELETE_SESSION",sessionId:e}),await _(),await O()}catch(t){console.error("Failed to delete session:",t),alert("Failed to delete session")}}function le(e){let t=Math.floor(e/1e3),n=Math.floor(t/60);return n<1?`${t}s`:n<60?`${n}m ${t%60}s`:`${Math.floor(n/60)}h ${n%60}m`}async function de(){try{p.textContent="Exporting...",p.setAttribute("disabled","true");let e=await chrome.runtime.sendMessage({type:"EXPORT_ALL_SESSIONS"});if(e.success&&e.data){let t=new Blob([e.data],{type:"text/markdown"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`dom-chronicle-export-${Date.now()}.md`,o.click(),URL.revokeObjectURL(n)}}catch(e){console.error("Failed to export sessions:",e),alert("Failed to export sessions")}finally{p.textContent="Export All Sessions",p.removeAttribute("disabled")}}async function ue(){if(confirm("Delete ALL recordings and settings? This cannot be undone.")&&confirm("Are you sure? This will permanently delete all data."))try{await chrome.runtime.sendMessage({type:"CLEAR_ALL_DATA"}),u=[],E.clear(),v(),await O(),await _(),$()}catch(e){console.error("Failed to clear data:",e),alert("Failed to clear data")}}function b(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}function q(e,t){return e.length>t?e.substring(0,t-1)+"\u2026":e}L.addEventListener("change",m);h.addEventListener("change",m);N.addEventListener("change",m);w.addEventListener("change",m);A.addEventListener("change",m);R.addEventListener("change",m);z.addEventListener("click",se);J.addEventListener("click",D);k.addEventListener("submit",re);M.addEventListener("change",j);p.addEventListener("click",de);Z.addEventListener("click",ue);I.addEventListener("click",e=>{e.target===I&&D()});document.addEventListener("DOMContentLoaded",te);
