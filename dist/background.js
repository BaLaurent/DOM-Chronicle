var j="dom-chronicle";var a={SESSIONS:"sessions",EVENTS:"events",CONFIG:"config"},N={MAX_EVENTS_IN_MEMORY:500,MAX_DOM_FRAGMENT_SIZE:2e3,MAX_EVENTS_PER_SESSION:5e4,BUFFER_FLUSH_INTERVAL:500,SESSION_AUTO_STOP_HOURS:2,INPUT_DEBOUNCE_MS:100,SCROLL_THROTTLE_MS:200},E={maxInitialHTMLSize:100*1024,diffMode:"line",includeParentContext:!0},g={captureScrollEvents:!1,captureMouseMovement:!1,debounceMs:100,maxEventsPerMinute:1e3,exportConfig:E};var h=null;async function u(){return h||new Promise((o,e)=>{let t=indexedDB.open(j,1);t.onerror=()=>e(t.error),t.onsuccess=()=>{h=t.result,o(h)},t.onupgradeneeded=r=>{let n=r.target.result;if(!n.objectStoreNames.contains(a.SESSIONS)){let s=n.createObjectStore(a.SESSIONS,{keyPath:"id"});s.createIndex("startedAt","startedAt"),s.createIndex("url","url")}if(!n.objectStoreNames.contains(a.EVENTS)){let s=n.createObjectStore(a.EVENTS,{keyPath:"id"});s.createIndex("sessionId","sessionId"),s.createIndex("timestamp","timestamp"),s.createIndex("type","type"),s.createIndex("session-sequence",["sessionId","sequence"])}n.objectStoreNames.contains(a.CONFIG)||n.createObjectStore(a.CONFIG,{keyPath:"key"})}})}async function H(o){let t=(await u()).transaction(a.EVENTS,"readwrite"),r=t.objectStore(a.EVENTS);for(let n of o)r.add(n);return new Promise((n,s)=>{t.oncomplete=()=>n(),t.onerror=()=>s(t.error)})}async function G(o){let t=(await u()).transaction(a.SESSIONS,"readwrite");return t.objectStore(a.SESSIONS).add(o),new Promise((n,s)=>{t.oncomplete=()=>n(),t.onerror=()=>s(t.error)})}async function I(o){let t=(await u()).transaction(a.SESSIONS,"readwrite");return t.objectStore(a.SESSIONS).put(o),new Promise((n,s)=>{t.oncomplete=()=>n(),t.onerror=()=>s(t.error)})}async function q(o){let n=(await u()).transaction(a.SESSIONS,"readonly").objectStore(a.SESSIONS).get(o);return new Promise((s,i)=>{n.onsuccess=()=>s(n.result),n.onerror=()=>i(n.error)})}async function D(){let n=(await u()).transaction(a.SESSIONS,"readonly").objectStore(a.SESSIONS).index("startedAt").getAll();return new Promise((s,i)=>{n.onsuccess=()=>{let c=n.result;s(c.reverse())},n.onerror=()=>i(n.error)})}async function C(o){let n=(await u()).transaction(a.EVENTS,"readonly").objectStore(a.EVENTS).index("session-sequence"),s=IDBKeyRange.bound([o,0],[o,Number.MAX_SAFE_INTEGER]),i=n.getAll(s);return new Promise((c,B)=>{i.onsuccess=()=>c(i.result),i.onerror=()=>B(i.error)})}async function W(o){let e=await u(),t=e.transaction(a.SESSIONS,"readwrite");t.objectStore(a.SESSIONS).delete(o),await new Promise((i,c)=>{t.oncomplete=()=>i(),t.onerror=()=>c(t.error)});let r=await C(o),n=e.transaction(a.EVENTS,"readwrite"),s=n.objectStore(a.EVENTS);for(let i of r)s.delete(i.id);return new Promise((i,c)=>{n.oncomplete=()=>i(),n.onerror=()=>c(n.error)})}async function y(o){let s=(await u()).transaction(a.EVENTS,"readonly").objectStore(a.EVENTS).index("sessionId").count(o);return new Promise((i,c)=>{s.onsuccess=()=>i(s.result),s.onerror=()=>c(s.error)})}async function p(o){let n=(await u()).transaction(a.CONFIG,"readonly").objectStore(a.CONFIG).get(o);return new Promise((s,i)=>{n.onsuccess=()=>s(n.result?.value),n.onerror=()=>i(n.error)})}var d=null,w="idle";async function X(o,e,t){if(d)throw new Error("A session is already active");let r={id:crypto.randomUUID(),startedAt:Date.now(),url:o,title:e,config:{...g,redactionRules:[],...t},eventCount:0};return await G(r),d=r,w="recording",r}async function v(){if(!d)return null;let o=await y(d.id);d.endedAt=Date.now(),d.eventCount=o,await I(d);let e=d;return d=null,w="idle",e}function P(){return d}function A(){return w}async function z(o){if(!d)throw new Error("No active session");if(await y(d.id)+o.length>N.MAX_EVENTS_PER_SESSION){console.warn("Session event limit reached, stopping recording"),await v();return}await H(o)}async function O(){return D()}async function Y(o){return q(o)}async function R(o){return C(o)}async function _(o){if(d?.id===o)throw new Error("Cannot delete active session");return W(o)}function K(){if(!d)return!1;let o=Date.now()-d.startedAt,e=N.SESSION_AUTO_STOP_HOURS*60*60*1e3;return o>=e}async function Z(){let e=(await D()).find(t=>!t.endedAt);e&&(e.endedAt=Date.now(),e.eventCount=await y(e.id),await I(e)),d=null,w="idle"}var J=`# DOM Chronicle Recording
## Session: {title}

**URL:** {url}
**Recorded:** {startTime} - {endTime}
**Duration:** {duration}
**Events:** {eventCount}
`,Q=`## Context for LLM

This recording captures user interactions and DOM changes on a web page.
Use this to understand what the user did and what happened in response.

**Format Guide:**
- \`[ACTION]\` = User-initiated action
- \`[MUTATION]\` = DOM change (automatic)
- \`[ERROR]\` = JavaScript or console error
- \`[NAV]\` = Navigation event
- Code blocks contain relevant DOM fragments
`,ee=`## Summary

| Metric | Value |
|--------|-------|
| Total Actions | {actionCount} |
| Total Mutations | {mutationCount} |
| Errors | {errorCount} |
| Navigations | {navCount} |
| Redactions Applied | {redactionCount} |
`,te={"mutation:add":"[MUTATION] Element Added","mutation:remove":"[MUTATION] Element Removed","mutation:attribute":"[MUTATION] Attribute Changed","mutation:text":"[MUTATION] Text Changed","user:click":"[ACTION] Click","user:input":"[ACTION] Input","user:scroll":"[ACTION] Scroll","user:navigation":"[NAV] Navigation","user:focus":"[ACTION] Focus","user:blur":"[ACTION] Blur","network:xhr":"[NETWORK] XHR Request","network:fetch":"[NETWORK] Fetch Request","error:js":"[ERROR] JavaScript Error","error:console":"[ERROR] Console Error"};function ne(o,e){let t=o-e,r=Math.floor(t/6e4),n=Math.floor(t%6e4/1e3),s=Math.floor(t%1e3);return`${r.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}.${s.toString().padStart(3,"0")}`}function $(o){return new Date(o).toISOString().replace("T"," ").substring(0,19)}function oe(o,e){let t=e-o,r=Math.floor(t/1e3),n=Math.floor(r/60),s=Math.floor(n/60);return s>0?`${s}h ${n%60}m ${r%60}s`:n>0?`${n}m ${r%60}s`:`${r}s`}function S(o){return o.replace(/([*_`\[\]()#>])/g,"\\$1")}function b(o,e="html"){return`\`\`\`${e}
${o}
\`\`\``}function l(o,e){return o.length<=e?o:o.substring(0,e-3)+"..."}function L(o,e){let t=o.split(`
`),r=e.split(`
`),n=[];return t.forEach(s=>{r.includes(s)||n.push(`- ${s}`)}),r.forEach(s=>{t.includes(s)||n.push(`+ ${s}`)}),n.join(`
`)}function re(o){return o.split(`
`).map(e=>`+ ${e}`).join(`
`)}function se(o){return o.split(`
`).map(e=>`- ${e}`).join(`
`)}function ie(o,e,t){return`- ${o}="${e}"
+ ${o}="${t}"`}var le={includeReproductionSteps:!0,maxDOMFragmentLength:500,groupMutations:!0},k=class{options;constructor(e){this.options={...le,...e}}export(e,t){let r=[this.renderHeader(e),Q],n=this.renderInitialPageSource(t);return n&&r.push("---",n),r.push("---","## Timeline",this.renderTimeline(e,t),"---",this.renderSummary(t)),this.options.includeReproductionSteps&&r.push("---",this.renderReproductionSteps(e,t)),r.join(`

`)}renderInitialPageSource(e){let t=e.find(n=>n.type==="user:navigation"&&n.payload.initialHTML);if(!t)return null;let r=t.payload;return r.initialHTML?`## Initial Page Source

${b(r.initialHTML)}`:null}renderHeader(e){return J.replace("{title}",S(e.title)).replace("{url}",e.url).replace("{startTime}",$(e.startedAt)).replace("{endTime}",e.endedAt?$(e.endedAt):"In Progress").replace("{duration}",e.endedAt?oe(e.startedAt,e.endedAt):"N/A").replace("{eventCount}",e.eventCount.toString())}renderTimeline(e,t){let r=e.startedAt,n=[];n.push(this.renderInitialLoad(e));for(let s of t){let i=this.renderEvent(s,r);i&&n.push(i)}return n.join(`

`)}renderInitialLoad(e){return`### 00:00.000 [ACTION] Page Load
Initial page loaded: **${S(e.title)}**

${b(`<title>${S(e.title)}</title>`)}`}renderEvent(e,t){let r=ne(e.timestamp+t,t),n=te[e.type]||`[${e.type}]`,s=this.describeEvent(e),i=this.renderDOMFragment(e);if(!s)return null;let c=`### ${r} ${n}
${s}`;return i&&(c+=`

${i}`),c}describeEvent(e){let t=e.target.label?`**"${S(l(e.target.label,50))}"**`:`**${e.target.tagName}**`,r=`(\`${e.target.cssSelector}\`)`;switch(e.type){case"user:click":{let n=e.payload,s=`User clicked ${t} ${r}`;if(n.modifiers.ctrl||n.modifiers.shift||n.modifiers.alt||n.modifiers.meta){let i=[];n.modifiers.ctrl&&i.push("Ctrl"),n.modifiers.shift&&i.push("Shift"),n.modifiers.alt&&i.push("Alt"),n.modifiers.meta&&i.push("Meta"),s+=` with ${i.join("+")}`}return s}case"user:input":{let n=e.payload,s=e.target.label||"input field",i=`User typed in **"${S(s)}"** ${r}`;return n.value.startsWith("[")&&n.value.endsWith("]")?i+=`

**Value:** \`${n.value}\` *(redacted)*`:n.value&&(i+=`

**Value:** \`${S(l(n.value,100))}\``),i}case"user:focus":case"user:blur":return`User ${e.payload.focused?"focused on":"left"} ${t} ${r}`;case"user:scroll":{let n=e.payload;return`Scrolled to position (${n.scrollX}, ${n.scrollY})`}case"user:navigation":{let n=e.payload;return`Navigated to: \`${n.url}\` (${n.type})`}case"mutation:add":{let n=e.payload,s=n.addedNodes?.length||0,i=`${s} element${s!==1?"s":""} added to ${r}`,c=this.renderMutationDiff(n,"add");return c&&(i+=`

${c}`),i}case"mutation:remove":{let n=e.payload,s=n.removedNodes?.length||0,i=`${s} element${s!==1?"s":""} removed from ${r}`,c=this.renderMutationDiff(n,"remove");return c&&(i+=`

${c}`),i}case"mutation:attribute":{let n=e.payload,s=ie(n.attributeName||"unknown",n.oldValue||"",n.newValue||"");return`Attribute \`${n.attributeName}\` changed on ${t}

\`\`\`diff
${s}
\`\`\``}case"mutation:text":{let n=e.payload,s=L(n.oldValue||"",n.newValue||"");return`Text content changed in ${t}

\`\`\`diff
${s}
\`\`\``}default:return`Event: ${e.type}`}}renderDOMFragment(e){if(!e.domSnapshot)return null;let t=l(e.domSnapshot.html,this.options.maxDOMFragmentLength);return!t||t.length<10?null:`**Element:**
${b(t)}`}renderMutationDiff(e,t){let r=this.options.exportConfig?.diffMode??"line";if(e.parentHTMLBefore&&e.parentHTMLAfter){let n=L(e.parentHTMLBefore,e.parentHTMLAfter);if(n)return`\`\`\`diff
${n}
\`\`\``}return t==="add"&&e.addedNodes?.length?`\`\`\`diff
${e.addedNodes.map(s=>re(l(s.html,this.options.maxDOMFragmentLength))).join(`
`)}
\`\`\``:t==="remove"&&e.removedNodes?.length?`\`\`\`diff
${e.removedNodes.map(s=>se(l(s.html,this.options.maxDOMFragmentLength))).join(`
`)}
\`\`\``:null}renderSummary(e){let t={actions:0,mutations:0,errors:0,navs:0,redactions:0};for(let r of e)if(r.type.startsWith("user:")?t.actions++:r.type.startsWith("mutation:")?t.mutations++:r.type.startsWith("error:")&&t.errors++,r.type==="user:navigation"&&t.navs++,r.type==="user:input"){let n=r.payload;n.value.startsWith("[")&&n.value.endsWith("]")&&t.redactions++}return ee.replace("{actionCount}",t.actions.toString()).replace("{mutationCount}",t.mutations.toString()).replace("{errorCount}",t.errors.toString()).replace("{navCount}",t.navs.toString()).replace("{redactionCount}",t.redactions.toString())}renderReproductionSteps(e,t){let r=[`1. Navigate to \`${e.url}\``],n=2;for(let s of t){let i=this.eventToStep(s);i&&(r.push(`${n}. ${i}`),n++)}return`## Reproduction Steps

${r.join(`
`)}`}eventToStep(e){let t=e.target.label||e.target.cssSelector;switch(e.type){case"user:click":return`Click "${l(t,30)}"`;case"user:input":{let r=e.payload;return r.value.startsWith("[")&&r.value.endsWith("]")?`Fill "${l(t,30)}" with ${r.value}`:`Fill "${l(t,30)}" with value`}case"user:navigation":return`Observe navigation to \`${e.payload.url}\``;case"user:scroll":return null;case"user:focus":case"user:blur":return null;case"mutation:add":return`Observe new element in "${l(t,30)}"`;case"mutation:remove":return`Observe element removed from "${l(t,30)}"`;default:return null}}};function U(o,e,t){return new k(t).export(o,e)}var ae=[{id:"input-password",name:"Password fields",type:"input-type",pattern:"password",replacement:"[PASSWORD]",enabled:!0},{id:"input-hidden",name:"Hidden inputs",type:"input-type",pattern:"hidden",replacement:"[HIDDEN]",enabled:!0},{id:"regex-email",name:"Email addresses",type:"regex",pattern:"[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}",replacement:"[EMAIL]",enabled:!0},{id:"regex-phone",name:"Phone numbers",type:"regex",pattern:"(\\+?1?[-.\\s]?)?(\\(?\\d{3}\\)?[-.\\s]?)?\\d{3}[-.\\s]?\\d{4}",replacement:"[PHONE]",enabled:!0},{id:"regex-ssn",name:"Social Security Numbers",type:"regex",pattern:"\\b\\d{3}-\\d{2}-\\d{4}\\b",replacement:"[SSN]",enabled:!0},{id:"regex-credit-card",name:"Credit card numbers",type:"regex",pattern:"\\b(?:\\d{4}[- ]?){3}\\d{4}\\b",replacement:"[CARD]",enabled:!0},{id:"regex-ip-address",name:"IP addresses",type:"regex",pattern:"\\b(?:\\d{1,3}\\.){3}\\d{1,3}\\b",replacement:"[IP]",enabled:!1},{id:"selector-cvv",name:"CVV fields",type:"selector",pattern:'input[name*="cvv"], input[name*="cvc"], input[autocomplete="cc-csc"]',replacement:"[CVV]",enabled:!0},{id:"attr-auth-token",name:"Auth tokens",type:"attribute",pattern:"data-token,data-auth,data-session,data-csrf",replacement:"[TOKEN]",enabled:!0}],pe=[/.*\.bank\..*/i,/.*banking.*/i,/paypal\.com/i,/venmo\.com/i,/stripe\.com/i,/square\.com/i,/.*\.health\..*/i,/.*medical.*/i,/.*patient.*/i,/.*\.gov\/health/i,/accounts\.google\.com/i,/login\.microsoftonline\.com/i,/auth0\.com/i,/okta\.com/i,/login\.salesforce\.com/i,/.*lastpass.*/i,/.*1password.*/i,/.*bitwarden.*/i,/.*dashlane.*/i,/.*\.gov$/i,/.*\.mil$/i];function ce(o){try{let e=new URL(o).hostname;return pe.some(t=>t.test(e))}catch{return!1}}var m=null,f=0,T=null;async function F(){console.log("[DOM Chronicle] Background service worker starting..."),await u(),await Z(),console.log("[DOM Chronicle] Background service worker ready")}chrome.runtime.onMessage.addListener((o,e,t)=>(me(o,e,t),!0));async function me(o,e,t){try{switch(o.type){case"START_RECORDING":await Se(t);break;case"STOP_RECORDING":await V(t);break;case"GET_STATUS":fe(t);break;case"STORE_EVENTS":await ge(o.events,t);break;case"GET_SESSIONS":await Ee(t);break;case"EXPORT_SESSION":await ve(o.sessionId,t);break;case"DELETE_SESSION":await he(o.sessionId,t);break;case"EXPORT_ALL_SESSIONS":await ye(t);break;case"CLEAR_ALL_DATA":await we(t);break;case"CHECK_SENSITIVE_DOMAIN":Oe(o.url,t);break;default:t({success:!1,error:"Unknown message type"})}}catch(r){console.error("[DOM Chronicle] Error handling message:",r),t({success:!1,error:r instanceof Error?r.message:"Unknown error"})}}async function Se(o){let[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e?.id||!e.url){o({success:!1,error:"No active tab"});return}let t=await be(),r=await X(e.url,e.title||"Untitled",t);m=e.id,f=0,await chrome.tabs.sendMessage(e.id,{type:"START_RECORDING",sessionId:r.id,config:t}),await x("recording"),Te(),o({success:!0,data:r})}async function V(o){if(m)try{await chrome.tabs.sendMessage(m,{type:"STOP_RECORDING"})}catch{}let e=await v();m=null,f=0,await x("idle"),de(),o({success:!0,data:e})}function fe(o){let e=A(),t=P();o({success:!0,data:{state:e,session:t,eventCount:f}})}async function ge(o,e){await z(o),f+=o.length,chrome.runtime.sendMessage({type:"EVENT_COUNT_UPDATE",count:f}).catch(()=>{}),e({success:!0})}async function Ee(o){let e=await O();o({success:!0,data:e})}async function ve(o,e){let t=await Y(o);if(!t){e({success:!1,error:"Session not found"});return}let r=await R(o),n=U(t,r);e({success:!0,data:n})}async function he(o,e){await _(o),e({success:!0})}async function ye(o){let e=await O(),t=[];for(let n of e){let s=await R(n.id),i=U(n,s);t.push(i)}let r=t.join(`

---

`);o({success:!0,data:r})}async function we(o){A()==="recording"&&(await v(),m=null,f=0,await x("idle"));let e=await O();for(let t of e)await _(t.id);o({success:!0})}function Oe(o,e){let t=ce(o);e({success:!0,data:t})}async function be(){let o=await p("captureScrollEvents")??g.captureScrollEvents,e=await p("debounceMs")??g.debounceMs,t=await p("maxEventsPerMinute")??g.maxEventsPerMinute,r=await p("customRedactionRules")??[],n=await p("disabledDefaultRules")??[],s=await p("maxInitialHTMLSize")??E.maxInitialHTMLSize,i=await p("diffMode")??E.diffMode,c=await p("includeParentContext")??E.includeParentContext;return{redactionRules:[...ae.map(M=>({...M,enabled:M.enabled&&!n.includes(M.id)})),...r],captureScrollEvents:o,captureMouseMovement:!1,debounceMs:e,maxEventsPerMinute:t,exportConfig:{maxInitialHTMLSize:s,diffMode:i,includeParentContext:c}}}async function x(o){let e=o==="recording"?{16:"icons/icon16.png",48:"icons/icon48.png",128:"icons/icon128.png"}:{16:"icons/icon16.png",48:"icons/icon48.png",128:"icons/icon128.png"};await chrome.action.setIcon({path:e}),o==="recording"?(await chrome.action.setBadgeText({text:"REC"}),await chrome.action.setBadgeBackgroundColor({color:"#ef4444"})):await chrome.action.setBadgeText({text:""})}function Te(){T=setInterval(async()=>{K()&&(console.log("[DOM Chronicle] Auto-stopping due to time limit"),await V(()=>{}))},6e4)}function de(){T&&(clearInterval(T),T=null)}chrome.tabs.onRemoved.addListener(async o=>{o===m&&(console.log("[DOM Chronicle] Active tab closed, stopping recording"),await v(),m=null,f=0,await x("idle"),de())});chrome.tabs.onUpdated.addListener(async(o,e,t)=>{if(o!==m||!e.url)return;let r=P();if(r)try{let n=new URL(r.url),s=new URL(e.url);n.hostname!==s.hostname&&(console.log("[DOM Chronicle] Domain changed, stopping recording"),await V(()=>{}))}catch{}});chrome.runtime.onInstalled.addListener(async o=>{console.log("[DOM Chronicle] Extension installed/updated:",o.reason),await F(),o.reason==="install"&&chrome.runtime.openOptionsPage()});chrome.runtime.onStartup.addListener(async()=>{console.log("[DOM Chronicle] Browser started"),await F()});F();
